name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW1GdWFXMWxZV3h3YUdFd01ERWlMQ0pTUlZCUElqb2lkR1Z6ZEdsdVp6QXdNU0lzSWxSSFgwRlFTVjlKUkNJNklqTTFOVEUwTmlJc0lsUkhYMEZRU1Y5SVFWTklJam9pTXpSa1pqUXdPRE0yTURGbU56bG1aamMwWVdZMll6VmpaRE5pTTJVek1HRWlMQ0pVUjE5Q1QxUmZWRTlMUlU0aU9pSTFNRFl3TURrd01qZzRPa0ZCUldNdFYxUkpOa0ZST1hKaVVTMUhYMFpGUmpWSk5tNUJRWEptWVhaVFRUSlJJaXdpUmtsTVJTSTZOalF5T0RNc0lrbEVJam9pTjNGUk1UWnJOWFJpUjFKSk1HUTJWVGxUUlhVaUxDSkRUVVFpT2lKbGVVcHFZakl4ZEZsWE5XdGplVWsyWlhsS2VscFhaSFJhVnpVd1kzbEpObGQ1U20xYWJURjNXbGRqWjB4WWEyZE1WelYyWXpOU2EyRlhOR2RNVjJod1drZFdabGx0Um5WaWJWWjVTVU14ZFdJelRqQlpXRko2U1VNeGMySXlaSE5hV0Zwc1lrTkNiR051U25aamFVRjBZVk5DZWxwWFpEZGpNbFp1WWxkV2RXUkViM2ROTWxJNVRHMHhjbVJwUVhSaVYwWjNTVVJCTm1ScFFYUlplbkF5U1VkNGNGbHVaM2xPYWxWblRGaENlVnBZVG14a1EwSjZZa2M1TTBsRE1UUk5hbGt4VEZoQ2FHTnRSblJqZVVGdVlrYzVkbUV5Um05YVYwWnJURmhPYzJGWFRteGplakF4VDI1S2FreFhlSFppTW5Sb1lVZFdhRnBFTURCTlJIQnBXbTVLYUdKWFZucFFWR2MyWWxkVk9XTXpVbWhqYW5Cb1kxTXhkR0l5VW14UVZFMDJZMjFXYlZCVVdUWmpTRTQxVEZoS2ExQlVSVFpaV0VWMFl6TlNlVnBYTlc1a1IyYzVUVU0wTkVwNVFYUmFiV3h6WkVkV2VWZ3lUblppV0VKeldsaG5aMG95TVhaa2JXeHNVRmhrYUdSSFZubGlWMFo1WVRFNWVscFlTbkJhV0UxMVkwYzFia2xHZEROWldGSnNZMjB4YUdOdGRHUlBNWE4zV0ZoT2FsbFhlR3hRVkdONVRVUnZkRTFVV1dkWE1teDFXRlIwWW1GWE5XUlhNMlJvWkVkV2VXSlhSbmxoTVRCbllqTmFiR050ZUdobFZEQjVUMnBKYmtsRE1XcGpiVmxuVFdwaloweFlRbkJsUmpsdFlsaFJaMlZZVmpKT1JFbDNZMFJGZDJKSFZXZGtiV3hyV2xjNGRHRXpkSHBhVjJSMFdsYzFNRTlxUVhwYVNEQjFZbGQwTWtsc01ITkpiVTUyWWxkS2NHSnRWV2xQYkhOcFdtMWFkR05IVm01SlF6RTFTVU14ZFdJelRqQmFSMngxU1VNeGIyRlhVbXhZTWtwb1ltMDFiR05wUVhSaWJUbDZaRWRHTUdONVFYUmlSemx1WWtkV01scFhkMmRhV0VwNVlqTkpaMHhYV1dkWk1qbDFXVEpHTUVsRE1YQkpTRTVzV2pJeGJHSnVVbnBNYlZwdFdUSkdNRWxETVdwSlIwNTJZMGhyWjJSdGJHdGFWemgwWVhrMWRHRXpXV2xNUTBwdFdtMHhkMXBYWTJkTVdHdG5URmMxZG1NelVtdGhWelJuVEZkb2NGcEhWbVpaYlVaMVltMVdlVWxETVhWaU0wNHdXVmhTZWtsRE1YTmlNbVJ6V2xoYWJHSkRRbXhqYmtwMlkybEJkR0ZUUWpkYWJXeHpXbGd3WjB4WE1XaGpRMEYzVDIxRk5rMUVPR2RNV0ZwMVNVTXhhazl0UldkaVIyeHBZak5DTVdONVFYUlpWMDFuVFdsQmRGbHFjR2hKUkZrd1lYbENhR1JYVW5CaWVUVjBZVEpGYVV4RFNtMWFiVEYzV2xkaloweFlhMmRNVnpWMll6TlNhMkZYTkdkTVYyaHdXa2RXWmxsdFJuVmliVlo1U1VNeGRXSXpUakJaV0ZKNlNVTXhjMkl5WkhOYVdGcHNZa05DYkdOdVNuWmphVUYwWVZOQ01tRlhVbXhpZVRGeVRHMHhjbVJwUVhSaFUwSm9aRmRTY0dKNU5YUmhNa1ZuVEZkcloyVXlXbkJpUjFZNVNVTXhkRmxZUVdkTlJIQXlTVU14ZEZsWVFXZE5WSEJvU1VNeGRGbFlRV2ROYW5CNlVIbEJkRmw2Y0doSlIwNTJZMGhyWjB4WFRUWmthVUpxWWpOQ05VbERNV3BQYmsxbldUSTVkMlZUUVc1ak1sWjVZVmRXZWtsSVRuQmFNakZvVEZaTmVFbEZWVE5KUldob1kwaENjR0p0Vm5wamVUVjBZVE5aYmtscGQybGFiVnAwWTBkV2JrbERNVFZKUXpGMVlqTk9NRnBIYkhWSlF6RnZZVmRTYkZneVNtaGliVFZzWTJsQmRHSnRPWHBrUjBZd1kzbEJkR0pIT1c1aVIxWXlXbGQzWjFwWVNubGlNMGxuVEZkclowb3pUbXhqYld4c1kzbENlbUZYWkhSWlV6RlVUVk5DUms1NVFrbFpXRUozWVZjMWJHTXpUWFZpVjNReVNubEJkR016VFdkTlJFRTJUVVJCTmsxRVJYVk5SRUYzU1VNeE1scHVTbWhpVjFaNlNVUkZaMHhZVFdkTmVrbDNaVVJOZVUxRFFqQmhTRlowV1drMWNXTkhWbTVKYVhkcFdtMWFkR05IVm01SlF6RTFTVU14ZFdJelRqQmFSMngxU1VNeGIyRlhVbXhZTWtwb1ltMDFiR05wUVhSaWJUbDZaRWRHTUdONVFYUmlSemx1WWtkV01scFhkMmRhV0VwNVlqTkpaMHhYYTJkS00wNXNZMjFzYkdONVFucGhWMlIwV1ZNeFZFMVRRa1pPZVVKSldWaENkMkZYTld4ak0wMTFZbGQwTWtwNVFYUmpNMDFuVFVSQk5rMUVUVFpOUkVGMVRVUkJkMGxETVRKYWJrcG9ZbGRXZWtsRVJXZE1XRTFuVFhwSmQyVkVUWGxOUTBJd1lVaFdkRmxwTlhGalIxWnVTV3d4T1V4RFNuWmtXRkozWkZoU2VrbHFjR0psZVVwdFlWZDRiRWxxYjJsak1sWjVZVmRXZWtsSVRuQmFNakZvVEZaTmVFbEZWVE5KUldob1kwaENjR0p0Vm5wamVUVjBZVE5aYVV4RFNqQmhTRlowV1dsSk5rbHVVbTlrVnpGcFRHMXdkMXBYWTJsTVEwcHpXVmMxYmtscWIybGFWelZ1U1c0eFpHWlJQVDBpZlE9PQ==
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
