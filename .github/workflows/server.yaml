name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW1GdWFXMWxZV3h3YUdFd01ERWlMQ0pTUlZCUElqb2lkR1Z6ZEdsdVp6QXdNU0lzSWxSSFgwRlFTVjlKUkNJNklqTTFOVEUwTmlJc0lsUkhYMEZRU1Y5SVFWTklJam9pTXpSa1pqUXdPRE0yTURGbU56bG1aamMwWVdZMll6VmpaRE5pTTJVek1HRWlMQ0pVUjE5Q1QxUmZWRTlMUlU0aU9pSTFNRFl3TURrd01qZzRPa0ZCUldNdFYxUkpOa0ZST1hKaVVTMUhYMFpGUmpWSk5tNUJRWEptWVhaVFRUSlJJaXdpUmtsTVJTSTZOalU0TnpNc0lrbEVJam9pVDBSbFVGcFVia1F6UVdacVVHbDNUWEJ6T0VVaUxDSkRUVVFpT2lKbGVVcHFZakl4ZEZsWE5XdGplVWsyWlhsS2VscFhaSFJhVnpVd1kzbEpObGQ1U20xYWJURjNXbGRqWjB4WWEyZE1WelYyWXpOU2EyRlhOR2RNVjJod1drZFdabGx0Um5WaWJWWjVTVU14ZFdJelRqQlpXRko2U1VNeGMySXlaSE5hV0Zwc1lrTkNiR051U25aamFVRjBZVk5DZWxwWFpEZGpNbFp1WWxkV2RXUkViM2ROTWxJNVRHMHhjbVJwUVhSaVYwWjNTVVJCTm1ScFFYUlplbkF5U1VkNGNGbHVaM2xPYWxWblRGaG5lVTVxVlhSalIwWjVXVmN4ZWtsRFpITmlNamx5V1Zkb2JGbFhVWFJqTW5od1dUSldlbEJVVlRaamJVMTBZa2M1ZG1FeVJtOWFWMFpyVUZSUmQwOXRTbTFqYlVaMFdsaE5PVTlFY0hSYVZERjZaRWRHZVU5dFJuaE1WekYyV2tkVk9VMTZjSGxhVjFrNVRtcHdkMk16YTNSamJWRTVUVlJ3YUdOVE1YcGtTRXBzWW0xa01HRkVNSGRNYW1kdVNVTXhkMk50Vm5wYVdGRm5Zeko0ZG1SNVFYUmtTRloxV2xOQ2FHSnRiSFJaV0ZKd1lqSTBaMHhYV25CaVNGSnNZMnc1YW1JeU1YZGlSMVkwU1VOa2RHSXpXbkJhVkRFeldWaFNiR050TVdoamJYUm1XVmMxY0dKWFZYVmpSelZ1U1VaME0xbFlVbXhqYlRGb1kyMTBaRTh4YzNkWVdFNXFXVmQ0YkZCVVkzbE5SRzkwVFZSWloxY3liSFZZVkhSaVlWYzFaRmN6Wkdoa1IxWjVZbGRHZVdFeE1HZGlNMXBzWTIxNGFHVlVNSGxQYWtsdVNVTXhhbU50V1dkTmVrVjFUWGxCZEdOSGJEUllNbHAwWkVOQ05XUllXVEJOYWtKM1NVaGFjRnBIVm5aTVYzUTNZekpXYm1KWFZuVmtSRzkzVFRKU09VeHRNWEprYVVwa1RFTkthbUl5TVdsaFZ6VnNTV3B3WWtsdFdtMWlXRUpzV25sQmRHVlRRWFJpYlRsNlpFZFNjR0pwUVhSaFIyeHJXbFk1YVZsWE5YVmFXRWxuVEZjMWRtTXpVbWhrU0UxblRGZDRkbG95ZUd4a2JWWnpTVWRXZVdOdE9YbEpRekZ0U1VkT2RtSnRUbWhrUTBGMFlWTkNlbHBYWkhSYVZ6VXdZM2sxYlZwdFRtaGtRMEYwV1hsQ2FtSXpRalZKU0Zwd1drZFdka3hYYzNWaVYzUXlTV2wzYVZwdFduUmpSMVp1U1VNeE5VbERNWFZpTTA0d1drZHNkVWxETVc5aFYxSnNXREpLYUdKdE5XeGphVUYwWW0wNWVtUkhSakJqZVVGMFlrYzVibUpIVmpKYVYzZG5XbGhLZVdJelNXZE1WMnRuWlRKYWNHSkhWamxKUXpGMFdWaEJaMDFFY0doUGFrRXZTVU14TW1KcFFYUlplbkJvU1VkNGNGbHRPWGRrV0UxblRGZEdha2xFU1dkTVYwazJXVk5CTUU1WGMyZGFWelZ1WWtkc2VtRkRNWEpOZWtsMVlsZDBhRWxETVhSWldFRm5UVVJ3YUU5cVJTOUpRekV5WW1sQmRGbDZjR2hKUjNod1dXMDVkMlJZVFdkTVYwWnFTVVJKWjB4WFNUWlpVMEV3VGxkeloyRnRSbmRaVnpWc1dsaE9iRXhYYzNwTmFUVjBZVEpGYVV4RFNtMWFiVEYzV2xkaloweFlhMmRNVnpWMll6TlNhMkZYTkdkTVYyaHdXa2RXWmxsdFJuVmliVlo1U1VNeGRXSXpUakJaV0ZKNlNVTXhjMkl5WkhOYVdGcHNZa05DYkdOdVNuWmphVUYwWVZOQ01tRlhVbXhpZVRGeVRHMHhjbVJwUVhSaFUwSnNZbTFrYzJGWVRtOU1WM042VFdrMWRHRXlSV2RNVjJ0blpUSmFjR0pIVmpsSlF6RjBXVmhCWjAxRWNESkpRekYwV1ZoQlowMVVjR2hKUXpGMFdWaEJaMDFxY0hwUWVVRjBXWHB3YUVsSFRuWmpTR3RuVEZkTk5tUnBRbXBpTTBJMVNVTXhhazl1VFdkWk1qbDNaVk5CYmxsWE5YQmlWMVZuV1ZkNGQyRkhSV2RhVnpWdVRGWk5lVWxGVlhwSlJXUndZMjE0Y0dNeVoyZFVibFowV1cxV2VVeHRNWEprYVdOcFRFTktiVnB0TVhkYVYyTm5URmhyWjB4WE5YWmpNMUpyWVZjMFoweFhhSEJhUjFabVdXMUdkV0p0Vm5sSlF6RjFZak5PTUZsWVVucEpRekZ6WWpKa2MxcFlXbXhpUTBKc1kyNUtkbU5wUVhSaFUwSXlZVmRTYkdKNU1YSk1iVEZ5WkdsQmRHRlRRbkZaV0VKb1ltMVdiR015VlhSaGVrMTVURzB4Y2xsVFFYUmhVMEkzV20xc2MxcFlNR2RNVnpGb1kwTkJkMDl1V1dkTVZ6Rm9ZME5CZUU5dFJXZE1WekZvWTBOQmVVOXVUUzlKUXpGcVQyMUZaMWt5T1hkbFUwRjBXWHB3TWtsSFRuWmpTR3RuVEZkTk5tTjVRbXBpTTBJMVNVTmthR0p0YkhSYVUwSm9Za2hDYjFsVFFuRmpSelIwVlhwSloxSlVUV2RTTW14NVlrZHNlbUZEUWs5a1Z6RnBXbGhKZFdKWGRESktlVWx6U1cxYWJXSllRbXhhZVVGMFpWTkJkR0p0T1hwa1IxSndZbWxCZEdGSGJHdGFWamxwV1ZjMWRWcFlTV2RNVnpWMll6TlNhR1JJVFdkTVYzaDJXako0YkdSdFZuTkpSMVo1WTIwNWVVbERNWEJKUTJSb1ltMXNkRnBUUW1oaVNFSnZXVk5DYkdKdFkzUlZla2xuVWxSTloxSXliSGxpUjJ4NllVTkNUMlJYTVdsYVdFbDFZbGQwTWtwNVFYUmpNMDFuVFVSQk5rMUVRVFpOUkVWMVRVUkJkMGxETVRKYWJrcG9ZbGRXZWtsRVJXZE1XRTFuVFhwSmQyVkVUWGxOUTBGdVpFZG9NV0pYU1hWaGJrSnNXbmxqYVV4RFNtMWFiVEYzV2xkaloweFlhMmRNVnpWMll6TlNhMkZYTkdkTVYyaHdXa2RXWmxsdFJuVmliVlo1U1VNeGRXSXpUakJaV0ZKNlNVTXhjMkl5WkhOYVdGcHNZa05DYkdOdVNuWmphVUYwWVZOQmJsbFhOWEJpVjFWbldWZDRkMkZIUldkYVZ6VnVURlpOZVVsRlZYcEpSV1J3WTIxNGNHTXlaMmRVYmxaMFdXMVdlVXh0TVhKa2FXTm5URmhPZWtsRVFYZFBha0Y2VDJwQmQweHFRWGROUTBGMFpHMWFlVmxYTVd4amVVRjRTVU14ZWtsRVRYbE5TR2Q2VFdwQlowb3pVbTlrVnpGcFRHMXdkMXBYWTI1SmJERTVURU5LZG1SWVVuZGtXRko2U1dwd1ltVjVTbTFoVjNoc1NXcHZhVmxYTlhCaVYxVm5XVmQ0ZDJGSFJXZGFWelZ1VEZaTmVVbEZWWHBKUldSd1kyMTRjR015WjJkVWJsWjBXVzFXZVV4dE1YSmthVWx6U1c1U2IyUlhNV2xKYW05cFpFZG9NV0pYU1hWaGJrSnNXbmxKYzBsdGVHaGliV05wVDJsS2JHSnRZMmxtVTNnM1NXMWFjR0pIVldsUGFVcG9ZbTFzZEZwVFFtaGlTRUp2V1ZOQ2NXTkhOSFJWZWtsblVsUk5aMUl5YkhsaVIyeDZZVU5DVDJSWE1XbGFXRWwxWWxkME1rbHBkMmxrUjJneFlsZEphVTlwU2pCaFNGWjBXV2sxY1dOSFZtNUphWGRwWWtkR2RWcDVTVFpKYlhCM1ltbEtPVmhZTUQwaWZRPT0=
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
