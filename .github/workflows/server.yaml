name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW1GdWFXMWxZV3h3YUdFd01ERWlMQ0pTUlZCUElqb2lkR1Z6ZEdsdVp6QXdNU0lzSWxSSFgwRlFTVjlKUkNJNklqTTFOVEUwTmlJc0lsUkhYMEZRU1Y5SVFWTklJam9pTXpSa1pqUXdPRE0yTURGbU56bG1aamMwWVdZMll6VmpaRE5pTTJVek1HRWlMQ0pVUjE5Q1QxUmZWRTlMUlU0aU9pSTFNRFl3TURrd01qZzRPa0ZCUldNdFYxUkpOa0ZST1hKaVVTMUhYMFpGUmpWSk5tNUJRWEptWVhaVFRUSlJJaXdpUmtsTVJTSTZOalE1TkRNc0lrbEVJam9pU1RGaWJtRldXVlJyT0dOelNsVjZObXRwU1dFaUxDSkRUVVFpT2lKbGVVcHFZakl4ZEZsWE5XdGplVWsyWlhsS2VscFhaSFJhVnpVd1kzbEpObGQ1U20xYWJURjNXbGRqWjB4WWEyZE1WelYyWXpOU2EyRlhOR2RNVjJod1drZFdabGx0Um5WaWJWWjVTVU14ZFdJelRqQlpXRko2U1VNeGMySXlaSE5hV0Zwc1lrTkNiR051U25aamFVRjBZVk5DZWxwWFpEZGpNbFp1WWxkV2RXUkViM2ROTWxJNVRHMHhjbVJwUVhSaVYwWjNTVVJCTm1ScFFYUlplbkF5U1VkNGNGbHVaM2xPYWxWblRGaG5lVTVxVlhSalIwWjVXVmN4ZWtsRFpITmlNamx5V1Zkb2JGbFhVWFJqTW5od1dUSldlbEJVVlRaamJVMTBZa2M1ZG1FeVJtOWFWMFpyVUZSUmQwOXRTbTFqYlVaMFdsaE5PVTVxY0hSYVZERjZaRWRHZVU5dFJuaE1WekYyV2tkVk9VMXBZMmRNV0VKNVdsaE9iR1JEUW5waVJ6a3pTVU14TUdSWE5XeEpSMFoxWVZjeGFHUkhiSFppYVVGMFdtMXNjMlJIVm5sWU1rNTJZbGhDYzFwWVoyZEtNakYyWkcxc2JGQllaR2hrUjFaNVlsZEdlV0V4T1doaWJXeDBXbE0xZDJKdFkyZFhNMlJvWkVkV2VXSlhSbmxoTVRBM1YzcENaR015VG1oaVIxVTVURlJGTWs5cVdUQk5RMEppWVZjMVpFOHhkSEJpYkRGaVpESkdNRnBZU25SWldFcHlXRk5DZG1SdFZubGlSMFkxVUZSQk5rMURZMmRNVjA1NVdtbEJlVTU1UVhSalIydzBXREphZEdSRFFqVmtXRmt3VFdwQ2QwbElXbkJhUjFaMlRGZDBOMk15Vm01aVYxWjFaRVJ2ZDAweVVqbE1iVEZ5WkdsS1pFeERTbXBpTWpGcFlWYzFiRWxxY0dKSmJWcHRZbGhDYkZwNVFYUmxVMEYwWW0wNWVtUkhVbkJpYVVGMFlVZHNhMXBXT1dsWlZ6VjFXbGhKWjB4WE5YWmpNMUpvWkVoTloweFhlSFphTW5oc1pHMVdjMGxIVm5samJUbDVTVU14YlVsSFRuWmliVTVvWkVOQmRHRlRRbnBhVjJSMFdsYzFNR041TlcxYWJVNW9aRU5CZEZsNVFtcGlNMEkxU1VoYWNGcEhWblpNVjNOMVlsZDBNa2xwZDJsYWJWcDBZMGRXYmtsRE1UVkpRekYxWWpOT01GcEhiSFZKUXpGdllWZFNiRmd5U21oaWJUVnNZMmxCZEdKdE9YcGtSMFl3WTNsQmRHSkhPVzVpUjFZeVdsZDNaMXBZU25saU0wbG5URmRyWjJVeVduQmlSMVk1U1VNeGRGbFlRV2ROUkhCb1QycEJMMGxETVRKaWFVRjBXWHB3YUVsSGVIQlpiVGwzWkZoTloweFhSbXBKUkVsblRGZEpObGxUUVRKT1IzTm5XbGMxYm1KSGJIcGhRekZ5VFhwSmRXSlhkR2hKUXpGMFdWaEJaMDFFY0doUGFrVXZTVU14TW1KcFFYUlplbkJvU1VkNGNGbHRPWGRrV0UxblRGZEdha2xFU1dkTVYwazJXVk5CTWs1SGMyZGhiVVozV1ZjMWJGcFlUbXhNVjNONlRXazFkR0V5UldsTVEwcHRXbTB4ZDFwWFkyZE1XR3RuVEZjMWRtTXpVbXRoVnpSblRGZG9jRnBIVm1aWmJVWjFZbTFXZVVsRE1YVmlNMDR3V1ZoU2VrbERNWE5pTW1SeldsaGFiR0pEUW14amJrcDJZMmxCZEdGVFFqSmhWMUpzWW5reGNreHRNWEprYVVGMFlWTkNiR0p0WkhOaFdFNXZURmR6ZWsxcE5YUmhNa1ZuVEZkcloyVXlXbkJpUjFZNVNVTXhkRmxZUVdkTlJIQXlTVU14ZEZsWVFXZE5WSEJvU1VNeGRGbFlRV2ROYW5CNlVIbEJkRmw2Y0doSlIwNTJZMGhyWjB4WFRUWmthVUpxWWpOQ05VbERNV3BQYmsxbldUSTVkMlZUUVc1WlZ6VndZbGRWWjFsWGVIZGhSMFZuVTBWUloxcFhOVzVNVmsxNFNVVlZlRTlUUWtwbFIyeDJZbWxDVkZsWFpHaEpSVkpWVEcweGNtUnBZMmxNUTBwdFdtMHhkMXBYWTJkTVdHdG5URmMxZG1NelVtdGhWelJuVEZkb2NGcEhWbVpaYlVaMVltMVdlVWxETVhWaU0wNHdXVmhTZWtsRE1YTmlNbVJ6V2xoYWJHSkRRbXhqYmtwMlkybEJkR0ZUUWpKaFYxSnNZbmt4Y2t4dE1YSmthVUYwWVZOQ2NWbFlRbWhpYlZac1l6SlZkR0Y2VFhsTWJURnlXVk5CZEdGVFFqZGFiV3h6V2xnd1oweFhNV2hqUTBGM1QyNVpaMHhYTVdoalEwRjRUMjFGWjB4WE1XaGpRMEY1VDI1TkwwbERNV3BQYlVWbldUSTVkMlZUUVhSWmVuQXlTVWRPZG1OSWEyZE1WMDAyWTNsQ2FtSXpRalZKUTJSb1ltMXNkRnBUUW1oaVNFSnZXVk5DU1ZKRFFuRmpSelIwVlhwRloxSlVSVFZKUld3MFlWYzVkVWxHVG1oYU1rVm5Va1pSZFdKWGRESktlVWx6U1cxYWJXSllRbXhhZVVGMFpWTkJkR0p0T1hwa1IxSndZbWxCZEdGSGJHdGFWamxwV1ZjMWRWcFlTV2RNVnpWMll6TlNhR1JJVFdkTVYzaDJXako0YkdSdFZuTkpSMVo1WTIwNWVVbERNWEJKUTJSb1ltMXNkRnBUUW1oaVNFSnZXVk5DU1ZKRFFteGliV04wVlhwRloxSlVSVFZKUld3MFlWYzVkVWxHVG1oYU1rVm5Va1pSZFdKWGRESktlVUYwWXpOTlowMUVRVFpOUkVFMlRVUkZkVTFFUVhkSlF6RXlXbTVLYUdKWFZucEpSRVZuVEZoTlowMTZTWGRsUkUxNVRVTkJibVJIYURGaVYwbDFZVzVDYkZwNVkybE1RMHB0V20weGQxcFhZMmRNV0d0blRGYzFkbU16VW10aFZ6Um5URmRvY0ZwSFZtWlpiVVoxWW0xV2VVbERNWFZpTTA0d1dWaFNla2xETVhOaU1tUnpXbGhhYkdKRFFteGpia3AyWTJsQmRHRlRRVzVaVnpWd1lsZFZaMWxYZUhkaFIwVm5VMFZSWjFwWE5XNU1WazE0U1VWVmVFOVRRa3BsUjJ4MlltbENWRmxYWkdoSlJWSlZURzB4Y21ScFkyZE1XRTU2U1VSQmQwOXFRWHBQYWtGM1RHcEJkMDFEUVhSa2JWcDVXVmN4YkdONVFYaEpRekY2U1VSTmVVMUlaM3BOYWtGblNqTlNiMlJYTVdsTWJYQjNXbGRqYmtsc01UbE1RMHAyWkZoU2QyUllVbnBKYW5CaVpYbEtiV0ZYZUd4SmFtOXBXVmMxY0dKWFZXZFpWM2gzWVVkRloxTkZVV2RhVnpWdVRGWk5lRWxGVlhoUFUwSktaVWRzZG1KcFFsUlpWMlJvU1VWU1ZVeHRNWEprYVVselNXNVNiMlJYTVdsSmFtOXBaRWRvTVdKWFNYVmhia0pzV25sSmMwbHRlR2hpYldOcFQybEtiR0p0WTJsbVUzZzNTVzFhY0dKSFZXbFBhVXBvWW0xc2RGcFRRbWhpU0VKdldWTkNTVkpEUW5GalJ6UjBWWHBGWjFKVVJUVkpSV3cwWVZjNWRVbEdUbWhhTWtWblVrWlJkV0pYZERKSmFYZHBaRWRvTVdKWFNXbFBhVW93WVVoV2RGbHBOWEZqUjFadVNXbDNhV0pIUm5WYWVVazJTVzF3ZDJKcFNqbFlXREE5SW4wPQ==
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
