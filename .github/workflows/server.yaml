name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW1GdWFXMWxZV3h3YUdFd01ERWlMQ0pTUlZCUElqb2lkR1Z6ZEdsdVp6QXdNU0lzSWxSSFgwRlFTVjlKUkNJNklqTTFOVEUwTmlJc0lsUkhYMEZRU1Y5SVFWTklJam9pTXpSa1pqUXdPRE0yTURGbU56bG1aamMwWVdZMll6VmpaRE5pTTJVek1HRWlMQ0pVUjE5Q1QxUmZWRTlMUlU0aU9pSTFNRFl3TURrd01qZzRPa0ZCUldNdFYxUkpOa0ZST1hKaVVTMUhYMFpGUmpWSk5tNUJRWEptWVhaVFRUSlJJaXdpUmtsTVJTSTZOak01Tmprc0lrbEVJam9pYWpkdVFrMW9WMUp2VlRsTFUyd3hNblZoYVc4aUxDSkRUVVFpT2lKbGVVcHFZakl4ZEZsWE5XdGplVWsyWlhsS2VscFhaSFJhVnpVd1kzbEpObGQ1U20xYWJURjNXbGRqWjB4WWEyZE1WelYyWXpOU2EyRlhOR2RNVjJod1drZFdabGx0Um5WaWJWWjVTVU14ZFdJelRqQlpXRko2U1VNeGMySXlaSE5hV0Zwc1lrTkNiR051U25aamFVRjBZVk5DZWxwWFpEZGpNbFp1WWxkV2RXUkViM2ROTWxJNVRHMHhjbVJwUVhSaVYwWjNTVVJCTm1ScFFYUlplbkF5U1VkNGNGbHVaM2xPYWxWblRGaG5lVTVxVlhSalIwWjVXVmN4ZWtsRFpITmlNamx5V1Zkb2JGbFhVWFJqTW5od1dUSldlbEJVVlRaamJVMTBZa2M1ZG1FeVJtOWFWMFpyVUZSUmQwOXRTbTFqYlVaMFdsaE5PVTlFY0hSYVZERjZaRWRHZVU5dFJuaE1WekYyV2tkVk9VMTZjSGxhVjFrNVRtcHdkMk16YTNSamJWRTVUVlJ3YUdOVE1YcGtTRXBzWW0xa01HRkVNSGRNYW1kdVNVTXhkMk50Vm5wYVdGRm5Zeko0ZG1SNVFYUmtTRloxV2xOQ2FHSnRiSFJaV0ZKd1lqSTBaMHhYV25CaVNGSnNZMnc1YW1JeU1YZGlSMVkwU1VOa2RHSXpXbkJhVkRFeldWaFNiR050TVdoamJYUm1XVmMxY0dKWFZYVmpSelZ1U1VaME0xbFlVbXhqYlRGb1kyMTBaRTh4YzNkWVdFNXFXVmQ0YkZCVVkzbE5SRzkwVFZSWloxY3liSFZZVkhSaVlWYzFaRmN6Wkdoa1IxWjVZbGRHZVdFeE1HZGlNMXBzWTIxNGFHVlVNSGxQYWtsdVNVTXhhbU50V1dkTmVrbG5URmhDY0dWR09XMWlXRkZuWlZoV01rNUVTWGRqUkVWM1lrZFZaMlJ0Ykd0YVZ6aDBZVE4wZWxwWFpIUmFWelV3VDJwQmVscElNSFZpVjNReVNXd3djMGx0VG5aaVYwcHdZbTFWYVU5c2MybGFiVnAwWTBkV2JrbERNVFZKUXpGMVlqTk9NRnBIYkhWSlF6RnZZVmRTYkZneVNtaGliVFZzWTJsQmRHSnRPWHBrUjBZd1kzbEJkR0pIT1c1aVIxWXlXbGQzWjFwWVNubGlNMGxuVEZkWloxa3lPWFZaTWtZd1NVTXhjRWxJVG14YU1qRnNZbTVTZWt4dFdtMVpNa1l3U1VNeGFrbEhUblpqU0d0blpHMXNhMXBYT0hSaGVUVjBZVE5aYVV4RFNtMWFiVEYzV2xkaloweFlhMmRNVnpWMll6TlNhMkZYTkdkTVYyaHdXa2RXWmxsdFJuVmliVlo1U1VNeGRXSXpUakJaV0ZKNlNVTXhjMkl5WkhOYVdGcHNZa05DYkdOdVNuWmphVUYwWVZOQ04xcHRiSE5hV0RCblRGY3hhR05EUVhkUGJVVTJUVVE0WjB4WVduVkpRekZxVDIxRloySkhiR2xpTTBJeFkzbEJkRmxYVFdkTmFVRjBXV3B3YUVsRVVURmhlVUpzWW0xa2MyRllUbTlNVjNONlRXazFkR0V5UldkTVZ6Rm9ZME5CZDA5dFJUWk5WRGhuVEZoYWRVbERNV3BQYlVWbllrZHNhV0l6UWpGamVVRjBXVmROWjAxcFFYUlphbkJvU1VSUk1XRjVRbkZaV0VKb1ltMVdiR015VlhSaGVrMTVURzB4Y2xsVFNYTkpiVnB0WWxoQ2JGcDVRWFJsVTBGMFltMDVlbVJIVW5CaWFVRjBZVWRzYTFwV09XbFpWelYxV2xoSloweFhOWFpqTTFKb1pFaE5aMHhYZUhaYU1uaHNaRzFXYzBsSFZubGpiVGw1U1VNeGNFbElXbkJhUjFaMlRGZHpkV0pYZERKSlF6RndTVWRXZFZveWVIQmpNbWQwWVhwTmVVeHRNWEpaVTBGMFlWTkNOMXB0YkhOYVdEQm5URmN4YUdORFFYZFBibGxuVEZjeGFHTkRRWGhQYlVWblRGY3hhR05EUVhsUGJrMHZTVU14YWs5dFJXZFpNamwzWlZOQmRGbDZjREpKUjA1MlkwaHJaMHhYVFRaamVVSnFZak5DTlVsRFpHaGliV3gwV2xOQ2FHSklRbTlaVTBKc1ltMWpkRlY2UldkU1ZFVjRTVVZGWjFFeU9URmpSM2hzU1VjNWJVbEZUakZaTW5SMllqTk5kV0pYZERKS2VVbHpTVzFhYldKWVFteGFlVUYwWlZOQmRHSnRPWHBrUjFKd1ltbEJkR0ZIYkd0YVZqbHBXVmMxZFZwWVNXZE1WelYyWXpOU2FHUklUV2RNVjNoMldqSjRiR1J0Vm5OSlIxWjVZMjA1ZVVsRE1YQkpTRnB3V2tkV2RreFhjM1ZpVjNReVNVTXhjRWxIY0doalIwWjFXbGRXZWxwVE1YSk5la2wxWWxkMGFFbERNWEJKU0hSdFlWZDRiR1pUUVhSaVYwWjNTVVJCTm1ScFFYUmlWMFozU1VSRk5sbFRRWFJpVjBaM1NVUkpObU42T0dkTVYwMDJXVk5DYW1JelFqVkpRekZxVDI1Wloxa3lPWGRsVTBGMFdYcHdla2xIVG5aalNHdG5TakpHZFdGWE1XeEpSMFp6WTBkb2FFbEhjSGRpYVRGVVRWTkNSazFVUldkUlUwSkVZak5XZDJKSFZXZGlNbGxuVVROV2FtRXlPWFpqZVRWMFlUTlpia2xwZDJsYWJWcDBZMGRXYmtsRE1UVkpRekYxWWpOT01GcEhiSFZKUXpGdllWZFNiRmd5U21oaWJUVnNZMmxCZEdKdE9YcGtSMFl3WTNsQmRHSkhPVzVpUjFZeVdsZDNaMXBZU25saU0wbG5URmRyWjBveVJuVmhWekZzU1VkR2MyTkhhR2hKUjFaMVdua3hWRTFUUWtaTlZFVm5VVk5DUkdJelZuZGlSMVZuWWpKWloxRXpWbXBoTWpsMlkzazFkR0V6V1c1SlF6RjZZM2xCZDAxRWIzZE5SRzkzVFZNMGQwMUVRV2RNV0ZwdFkyMUdkRnBZVFdkTlUwRjBZM2xCZWsxcVFqUk5la2wzU1VOa01HRklWblJaYVRWeFkwZFdia3A1U1hOSmJWcHRZbGhDYkZwNVFYUmxVMEYwWW0wNWVtUkhVbkJpYVVGMFlVZHNhMXBXT1dsWlZ6VjFXbGhKWjB4WE5YWmpNMUpvWkVoTloweFhlSFphTW5oc1pHMVdjMGxIVm5samJUbDVTVU14Y0VsRFpHaGliV3gwV2xOQ2FHSklRbTlaVTBKc1ltMWpkRlY2UldkU1ZFVjRTVVZGWjFFeU9URmpSM2hzU1VjNWJVbEZUakZaTW5SMllqTk5kV0pYZERKS2VVRjBZek5OWjAxRVFUWk5SRTAyVFVSQmRVMUVRWGRKUXpFeVdtNUthR0pYVm5wSlJFVm5URmhOWjAxNlNYZGxSRTE1VFVOQmJtUkhhREZpVjBsMVlXNUNiRnA1WTJsWVdEQnpTVzA1TVdSSVFqRmtTRTFwVDJ4ME4wbHRXbkJpUjFWcFQybEthR0p0YkhSYVUwSm9Za2hDYjFsVFFteGliV04wVlhwRloxSlVSWGhKUlVWblVUSTVNV05IZUd4SlJ6bHRTVVZPTVZreWRIWmlNMDExWWxkME1rbHBkMmxrUjJneFlsZEphVTlwU2pCaFNGWjBXV2sxY1dOSFZtNUphWGRwWWtkR2RWcDVTVFpKYlZaMVdubEtPVXhJYzJsYWJXeHpXbE5KTmtsdFJuVmhWekZzU1VkR2MyTkhhR2hKUjNCM1lta3hWRTFUUWtaTlZFVm5VVk5DUkdJelZuZGlSMVZuWWpKWloxRXpWbXBoTWpsMlkzazFkR0V6V1dsTVEwb3dZVWhXZEZscFNUWkpibEp2WkZjeGFVeHRjSGRhVjJOcFRFTktjMWxYTlc1SmFtOXBZVzVDZFVsdU1XUm1VVDA5SW4wPQ==
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
