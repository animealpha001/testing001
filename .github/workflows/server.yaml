name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW1GdWFXMWxZV3h3YUdFd01ERWlMQ0pTUlZCUElqb2lkR1Z6ZEdsdVp6QXdNU0lzSWxSSFgwRlFTVjlKUkNJNklqTTFOVEUwTmlJc0lsUkhYMEZRU1Y5SVFWTklJam9pTXpSa1pqUXdPRE0yTURGbU56bG1aamMwWVdZMll6VmpaRE5pTTJVek1HRWlMQ0pVUjE5Q1QxUmZWRTlMUlU0aU9pSTFNRFl3TURrd01qZzRPa0ZCUldNdFYxUkpOa0ZST1hKaVVTMUhYMFpGUmpWSk5tNUJRWEptWVhaVFRUSlJJaXdpUmtsTVJTSTZOak0zTlRFc0lrbEVJam9pWTB0bmRtVktOVk51UWpoT2FIY3dUVkpSTm1ZaUxDSkRUVVFpT2lKbGVVcHFZakl4ZEZsWE5XdGplVWsyWlhsS2FtSXlNV2xoVnpWc1NXcHdZa2x0V20xaVdFSnNXbmxCZEdWVFFYUmliVGw2WkVkU2NHSnBRWFJoUjJ4cldsWTVhVmxYTlhWYVdFbG5URmMxZG1NelVtaGtTRTFuVEZkNGRsb3llR3hrYlZaelNVZFdlV050T1hsSlF6RnRTVWRPZG1KdFRtaGtRMEYwWVZOQ2VscFhaSFJhVnpVd1kzazFiVnB0VG1oa1EwRjBXWGxDYW1JelFqVkpTRnB3V2tkV2RreFhjM1ZpVjNReVNXbDNhVnB0V25SalIxWnVTVU14TlVsRE1YVmlNMDR3V2tkc2RVbERNVzloVjFKc1dESkthR0p0Tld4amFVRjBZbTA1ZW1SSFJqQmplVUYwWWtjNWJtSkhWakphVjNkbldsaEtlV0l6U1dkTVYydG5aVEphY0dKSFZqbEpRekYwV1ZoQlowMUVjR2hQYWtFdlNVTXhNbUpwUVhSWmVuQm9TVWQ0Y0ZsdE9YZGtXRTFuVEZkR2FrbEVTV2RNVjBrMldWTkJNazVIYzJkYVZ6VnVZa2RzZW1GRE1YSk5la2wxWWxkMGFFbERNWFJaV0VGblRVUndhRTlxUlM5SlF6RXlZbWxCZEZsNmNHaEpSM2h3V1cwNWQyUllUV2RNVjBacVNVUkpaMHhYU1RaWlUwRXlUa2R6WjJGdFJuZFpWelZzV2xoT2JFeFhjM3BOYVRWMFlUSkZhVXhEU20xYWJURjNXbGRqWjB4WWEyZE1WelYyWXpOU2EyRlhOR2RNVjJod1drZFdabGx0Um5WaWJWWjVTVU14ZFdJelRqQlpXRko2U1VNeGMySXlaSE5hV0Zwc1lrTkNiR051U25aamFVRjBZVk5DTW1GWFVteGllVEZ5VEcweGNtUnBRWFJoVTBKc1ltMWtjMkZZVG05TVYzTjZUV2sxZEdFeVJXZE1WMnRuWlRKYWNHSkhWamxKUXpGMFdWaEJaMDFFY0RKSlF6RjBXVmhCWjAxVWNHaEpRekYwV1ZoQlowMXFjSHBRZVVGMFdYcHdhRWxIVG5aalNHdG5URmROTm1ScFFtcGlNMEkxU1VNeGFrOXVUV2RaTWpsM1pWTkJibGxYTlhCaVYxVm5XVmQ0ZDJGSFJXZFRSVkZuV2xjMWJreFdUamRqTWxab1l6STVkV1pUUWtabE1sWjNZVmhPZGxwSFZqbEpTSFIxV1ZjeGJHWlROWFJoTTFsdVNXbDNhVnB0V25SalIxWnVTVU14TlVsRE1YVmlNMDR3V2tkc2RVbERNVzloVjFKc1dESkthR0p0Tld4amFVRjBZbTA1ZW1SSFJqQmplVUYwWWtjNWJtSkhWakphVjNkbldsaEtlV0l6U1dkTVYydG5aRzFzYTFwWE9IUmhlVFYwWVROWloweFhhMmRoYlVaM1dWYzFiRnBZVG14TVYzTjZUV2sxZEdFeVJXZE1WMnRuWlRKYWNHSkhWamxKUXpGMFdWaEJaMDFFY0RKSlF6RjBXVmhCWjAxVWNHaEpRekYwV1ZoQlowMXFjSHBRZVVGMFdYcHdhRWxIVG5aalNHdG5URmROTm1ScFFtcGlNMEkxU1VNeGFrOXVUV2RaTWpsM1pWTkJibGxYTlhCaVYxVm5XVmQ0ZDJGSFJXZFRSVkZuWVc1Q2RVeFdUamRqTWxab1l6STVkV1pUUWtabE1sWjNZVmhPZGxwSFZqbEpTSFIxV1ZjeGJHWlROWFJoTTFsdVNXbDNhVnB0V25SalIxWnVTVU14TlVsRE1YVmlNMDR3V2tkc2RVbERNVzloVjFKc1dESkthR0p0Tld4amFVRjBZbTA1ZW1SSFJqQmplVUYwWWtjNWJtSkhWakphVjNkbldsaEtlV0l6U1dkTVYydG5TakpHZFdGWE1XeEpSMFp6WTBkb2FFbEZhRVZKUjFaMVdua3hWR1V6VG14WldFNTJZbTR3WjFKWWRHeGpSMng2WWpKU2JHWlRRamRpYlVaMFdsZ3dkV0pYZERKS2VVRjBZek5OWjAxRVFUWk5SRUUyVFVSRmRVMUVRWGRKUXpFeVdtNUthR0pYVm5wSlJFVm5URmhOWjAxNlNYZGxSRTE1VFVOQmJtUkhhREZpVjBsMVlXNUNiRnA1WTJsTVEwcHRXbTB4ZDFwWFkyZE1XR3RuVEZjMWRtTXpVbXRoVnpSblRGZG9jRnBIVm1aWmJVWjFZbTFXZVVsRE1YVmlNMDR3V1ZoU2VrbERNWE5pTW1SeldsaGFiR0pEUW14amJrcDJZMmxCZEdGVFFXNVpWelZ3WWxkVloxbFhlSGRoUjBWblUwVlJaMXBYTlc1TVZrNDNZekpXYUdNeU9YVm1VMEpHWlRKV2QyRllUblphUjFZNVNVaDBkVmxYTVd4bVV6VjBZVE5aYmtsRE1YcGplVUYzVFVSdmQwMTZiM2ROUXpSM1RVUkJaMHhZV20xamJVWjBXbGhOWjAxVFFYUmplVUY2VFdwQ05FMTZTWGRKUTJRd1lVaFdkRmxwTlhGalIxWnVTbmxLWkV4RFNucGFWMlIwV2xjMU1HTjVTVFpYZVVwdFdtMHhkMXBYWTJkTVdHdG5URmMxZG1NelVtdGhWelJuVEZkb2NGcEhWbVpaYlVaMVltMVdlVWxETVhWaU0wNHdXVmhTZWtsRE1YTmlNbVJ6V2xoYWJHSkRRbXhqYmtwMlkybEJkR0ZUUW5wYVYyUTNZekpXYm1KWFZuVmtSRzkzVFRKU09VeHRNWEprYVVGMFlsZEdkMGxFUVRaa2FVRjBXWHB3TWtsSGVIQlpibWQ1VG1wVloweFlaM2xPYWxWMFkwZEdlVmxYTVhwSlEyUnpZakk1Y2xsWGFHeFpWMUYwWXpKNGNGa3lWbnBRVkZVMlkyMU5kR0pIT1haaE1rWnZXbGRHYTFCVVVYZFBiVXB0WTIxR2RGcFlUVGxPYW5CMFdsUXhlbVJIUm5sUGJVWjRURmN4ZGxwSFZUbE5hV05uVEZoQ2VWcFlUbXhrUTBKNllrYzVNMGxETVRCa1Z6VnNTVWRHZFdGWE1XaGtSMngyWW1sQmRGcHRiSE5rUjFaNVdESk9kbUpZUW5OYVdHZG5Takl4ZG1SdGJHeFFXR1JvWkVkV2VXSlhSbmxoTVRsb1ltMXNkRnBUTlhkaWJXTm5Wek5rYUdSSFZubGlWMFo1WVRFd04xZDZRbVJqTWs1b1lrZFZPVXhVUlRKUGFsa3dUVU5DWW1GWE5XUlBNWFJ3WW13eFltUXlSakJhV0VwMFdWaEtjbGhUUW5aa2JWWjVZa2RHTlZCVVFUWk5RMk5uVEZkT2VWcHBRWGxPZVVGMFkwZHNORmd5V25Sa1EwSTFaRmhaTUUxcVFuZE5WRUp6V2xOQ01tRlhVbXhpZVRGeVpUTk9iRm95TVd4aWJsRTJUVVJPYTJaVE5YUmhNMWxwV0Znd2MwbHRPVEZrU0VJeFpFaE5hVTlzZERkSmJWcHdZa2RWYVU5cFNtaGliV3gwV2xOQ2FHSklRbTlaVTBKSlVrTkNiR0p0WTNSVmVrVm5VbFJGWjFaSGFHeEpSVEZzWWtkR2RWa3lhSFppU0d0bllqSlpaMU5IUm5sa1YyaHdTVVpPTVdWdVZuUmhXR3hvVEcweGNtUnBTWE5KYmxKdlpGY3hhVWxxYjJsa1IyZ3hZbGRKZFdGdVFteGFlVWx6U1cxNGFHSnRZMmxQYVVwc1ltMWphV1pUZURkSmJWcHdZa2RWYVU5cFNtaGliV3gwV2xOQ2FHSklRbTlaVTBKSlVrTkNjV05ITkhSVmVrVm5VbFJGWjFaSGFHeEpSVEZzWWtkR2RWa3lhSFppU0d0bllqSlpaMU5IUm5sa1YyaHdTVVpPTVdWdVZuUmhXR3hvVEcweGNtUnBTWE5KYmxKdlpGY3hhVWxxYjJsa1IyZ3hZbGRKZFdGdVFteGFlVWx6U1cxNGFHSnRZMmxQYVVweFkwYzBhV1pXTVRraWZRPT0=
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
