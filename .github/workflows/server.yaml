name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SW1GdWFXMWxZV3h3YUdFd01ERWlMQ0pTUlZCUElqb2lkR1Z6ZEdsdVp6QXdNU0lzSWxSSFgwRlFTVjlKUkNJNklqTTFOVEUwTmlJc0lsUkhYMEZRU1Y5SVFWTklJam9pTXpSa1pqUXdPRE0yTURGbU56bG1aamMwWVdZMll6VmpaRE5pTTJVek1HRWlMQ0pVUjE5Q1QxUmZWRTlMUlU0aU9pSTFNRFl3TURrd01qZzRPa0ZCUldNdFYxUkpOa0ZST1hKaVVTMUhYMFpGUmpWSk5tNUJRWEptWVhaVFRUSlJJaXdpUmtsTVJTSTZOak00TXpBc0lrbEVJam9pTVZaM1ZtVTNTbmxwWm05RmNsQTNXRVZCT1VraUxDSkRUVVFpT2lKbGVVcHFZakl4ZEZsWE5XdGplVWsyWlhsS2VscFhaSFJhVnpVd1kzbEpObGQ1U20xYWJURjNXbGRqWjB4WWEyZE1WelYyWXpOU2EyRlhOR2RNVjJod1drZFdabGx0Um5WaWJWWjVTVU14ZFdJelRqQlpXRko2U1VNeGMySXlaSE5hV0Zwc1lrTkNiR051U25aamFVRjBZVk5DZWxwWFpEZGpNbFp1WWxkV2RXUkViM2ROTWxJNVRHMHhjbVJwUVhSaVYwWjNTVVJCTm1ScFFYUlplbkF5U1VkNGNGbHVaM2xPYWxWblRGaG5lVTVxVlhSalIwWjVXVmN4ZWtsRFpITmlNamx5V1Zkb2JGbFhVWFJqTW5od1dUSldlbEJVVlRaamJVMTBZa2M1ZG1FeVJtOWFWMFpyVUZSUmQwOXRTbTFqYlVaMFdsaE5PVTVxY0hSYVZERjZaRWRHZVU5dFJuaE1WekYyV2tkVk9VMXBZMmRNV0VKNVdsaE9iR1JEUW5waVJ6a3pTVU14TUdSWE5XeEpSMFoxWVZjeGFHUkhiSFppYVVGMFdtMXNjMlJIVm5sWU1rNTJZbGhDYzFwWVoyZEtNakYyWkcxc2JGQllaR2hrUjFaNVlsZEdlV0V4T1doaWJXeDBXbE0xZDJKdFkyZFhNMlJvWkVkV2VXSlhSbmxoTVRBM1YzcENaR015VG1oaVIxVTVURlJGTWs5cVdUQk5RMEppWVZjMVpFOHhkSEJpYkRGaVpESkdNRnBZU25SWldFcHlXRk5DZG1SdFZubGlSMFkxVUZSQk5rMURZMmRNVjA1NVdtbEJlVTU1UVhSalIydzBXREphZEdSRFFqVmtXRmt3VFdwQ2QwMVVRbk5hVTBJeVlWZFNiR0o1TVhKbE0wNXNXakl4YkdKdVVUWk5SRTVyWmxNMWRHRXpXV2xZVTNkcFdUSTVkRmx0YkhWYVUwazJWM2xLYlZwdE1YZGFWMk5uVEZocloweFhOWFpqTTFKcllWYzBaMHhYYUhCYVIxWm1XVzFHZFdKdFZubEpRekYxWWpOT01GbFlVbnBKUXpGellqSmtjMXBZV214aVEwSnNZMjVLZG1OcFFYUmFhVUpxWWpJMWFsbFlVV2RNVjJ0bll6SldibUpYVm5Wa1NFMTFXbTFhYWxsWVVXZE1WMDFuV1RJNWQyVlRRakpoVjFKc1lua3hja3h0TVhKa2FVbHpTVzFhYldKWVFteGFlVUYwWlZOQmRHSnRPWHBrUjFKd1ltbEJkR0ZIYkd0YVZqbHBXVmMxZFZwWVNXZE1WelYyWXpOU2FHUklUV2RNVjNoMldqSjRiR1J0Vm5OSlIxWjVZMjA1ZVVsRE1YQkpTSFJ0WVZkNGJHWlRRWFJpVjBaM1NVUkJObGxVYjNkUWVVRjBaRzAwWjB4WFRUWlpVMEp6WVZkS2RtTklWbnBKUXpGb1dYbEJlVWxETVdsUGJVVm5UbXBTY2tsSFZuVmFNbmh3WXpKbmRHRjZUWGxNYlRGeVdWTkJkR0pYUm5kSlJFRTJXVlJ2ZUZCNVFYUmtiVFJuVEZkTk5sbFRRbk5oVjBwMlkwaFdla2xETVdoWmVVRjVTVU14YVU5dFJXZE9hbEp5U1Vkd2FHTkhSblZhVjFaNldsTXhjazE2U1hWaVYzUm9TV2wzYVZwdFduUmpSMVp1U1VNeE5VbERNWFZpTTA0d1drZHNkVWxETVc5aFYxSnNXREpLYUdKdE5XeGphVUYwWW0wNWVtUkhSakJqZVVGMFlrYzVibUpIVmpKYVYzZG5XbGhLZVdJelNXZE1WMnRuWkcxc2ExcFhPSFJoZVRWMFlUTlpaMHhYYTJkYVZ6VnVZa2RzZW1GRE1YSk5la2wxWWxkMGFFbERNWEJKU0hSdFlWZDRiR1pUUVhSaVYwWjNTVVJCTm1ScFFYUmlWMFozU1VSRk5sbFRRWFJpVjBaM1NVUkpObU42T0dkTVYwMDJXVk5DYW1JelFqVkpRekZxVDI1Wloxa3lPWGRsVTBGMFdYcHdla2xIVG5aalNHdG5TakpHZFdGWE1XeEpSMFp6WTBkb2FFbEZhRVZKUjFaMVdua3hWRTFUUWtaUFEwSk9ZMmswWjFRelRuWmlWMFl3WXpOVmRXSlhkREpLZVVselNXMWFiV0pZUW14YWVVRjBaVk5CZEdKdE9YcGtSMUp3WW1sQmRHRkhiR3RhVmpscFdWYzFkVnBZU1dkTVZ6VjJZek5TYUdSSVRXZE1WM2gyV2pKNGJHUnRWbk5KUjFaNVkyMDVlVWxETVhCSlNGcHdXa2RXZGt4WGMzVmlWM1F5U1VNeGNFbEhjR2hqUjBaMVdsZFdlbHBUTVhKTmVrbDFZbGQwYUVsRE1YQkpTSFJ0WVZkNGJHWlRRWFJpVjBaM1NVUkJObVJwUVhSaVYwWjNTVVJGTmxsVFFYUmlWMFozU1VSSk5tTjZPR2RNVjAwMldWTkNhbUl6UWpWSlF6RnFUMjVaWjFreU9YZGxVMEYwV1hwd2VrbEhUblpqU0d0blNqSkdkV0ZYTVd4SlIwWnpZMGRvYUVsRmFFVkpSM0IzWW1reFZFMVRRa1pQUTBKT1kyazBaMVF6VG5aaVYwWXdZek5WZFdKWGRESktlVWx6U1cxYWJXSllRbXhhZVVGMFpWTkJkR0p0T1hwa1IxSndZbWxCZEdGSGJHdGFWamxwV1ZjMWRWcFlTV2RNVnpWMll6TlNhR1JJVFdkTVYzaDJXako0YkdSdFZuTkpSMVo1WTIwNWVVbERNWEJKUTJSb1ltMXNkRnBUUW1oaVNFSnZXVk5DU1ZKRFFteGliV04wVlhwRloxSlVaMmRVV0VsMVNVVTVlbUl5TVdoa1NFNHhURzB4Y21ScFkyZE1XRTU2U1VSQmQwOXFRWGRQYWtGNFRHcEJkMDFEUVhSa2JWcDVXVmN4YkdONVFYaEpRekY2U1VSTmVVMUlaM3BOYWtGblNqTlNiMlJYTVdsTWJYQjNXbGRqYmtscGQybGFiVnAwWTBkV2JrbERNVFZKUXpGMVlqTk9NRnBIYkhWSlF6RnZZVmRTYkZneVNtaGliVFZzWTJsQmRHSnRPWHBrUjBZd1kzbEJkR0pIT1c1aVIxWXlXbGQzWjFwWVNubGlNMGxuVEZkclowb3lSblZoVnpGc1NVZEdjMk5IYUdoSlJXaEZTVWRXZFZwNU1WUk5VMEpHVDBOQ1RtTnBOR2RVTTA1MllsZEdNR016VlhWaVYzUXlTbmxCZEdNelRXZE5SRUUyVFVSTk5rMUVRWFZOUkVGM1NVTXhNbHB1U21oaVYxWjZTVVJGWjB4WVRXZE5la2wzWlVSTmVVMURRVzVrUjJneFlsZEpkV0Z1UW14YWVXTnBXRmd3YzBsdE9URmtTRUl4WkVoTmFVOXNkRGRKYlZwd1lrZFZhVTlwU21oaWJXeDBXbE5DYUdKSVFtOVpVMEpKVWtOQ2JHSnRZM1JWZWtWblVsUm5aMVJZU1hWSlJUbDZZakl4YUdSSVRqRk1iVEZ5WkdsSmMwbHVVbTlrVnpGcFNXcHZhV1JIYURGaVYwbDFZVzVDYkZwNVNYTkpiWGhvWW0xamFVOXBTbXhpYldOcFpsTjROMGx0V25CaVIxVnBUMmxLYUdKdGJIUmFVMEpvWWtoQ2IxbFRRa2xTUTBKeFkwYzBkRlY2UldkU1ZHZG5WRmhKZFVsRk9YcGlNakZvWkVoT01VeHRNWEprYVVselNXNVNiMlJYTVdsSmFtOXBaRWRvTVdKWFNYVmhia0pzV25sSmMwbHRlR2hpYldOcFQybEtjV05ITkdsbVZqRTVJbjA9
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
